# AWS Greengrass using Parsec - Workshop

This is a short workshop on how to use PARSEC plugin in AWS Greengrass v2 Nucleaus to achieve native security across device hardware
Before you begin you should be family of both PARSEC and AWS Greengrass, have at least deployed both and understand the use case of both technologies, we recommend the following to become familur

* [AWS Greengrass V2 Workshop](https://catalog.us-east-1.prod.workshops.aws/v2/workshops/5ecc2416-f956-4273-b729-d0d30556013f/en-US/) 
* Parsec Walkthorugh with 

## DEMO
Located in this workshop is a "out of the box" demo setup which build and deploys the complete solution from the workshop learning steps, it is used as both a learning guide and short example when demonstrating the use of Parsec with AWS Greengrass

### How to get started

To get started you will need the following, an aarch64 or x86 device or your local computer, an active AWS account and your API credentials, Github access configurated locally
The demo.sh file will do the following

- Prepare Git and gitsubmodule (for sourcing the Java client, Greengrass Parsec plugin and build them )
- Build the docker containers that package in, AWS Greengrass, Parsec service and intermidate steps 

If you don't have hardware at hand, but still would like to test on an embedded device, then the ARM Hardware lab hosted by MiniNodes can help more info can be found here: https://github.com/WorksOnArm/mininodes-arm-edge

Tested on the following

- Apple M1 laptop (OSX Monterey 12.1)
- Intel based x86 workstation (test on Ubuntu, Fedora and ArchLinux)
- [Solid-Run MACCHIATOBin ARMADA 8040 (Cortex-A72)](https://developer.solid-run.com/article-categories/macchiatobin-single-double-shot/)
- [Solid-Run Honeycomb LXK2 NXP  (Cortex-A72)](https://www.solid-run.com/arm-servers-networking-platforms/honeycomb-workstation/)
- [Thundercomm RB5 5G development kit /w Qualcomm QRB5165 Snapdragon QRB5165 (Cortex-A)](https://www.thundercomm.com/app_en/product/1590131656070623)

TPM's currently being implemented as part of this workshop

- 96boards Secure96 TPM 
- Qualcomm SPU240 HW RoT / SPU (WIP)
- EDK II UEFI SoftTPM (new concept) 

### Demo build/run options.

Please notice that after cloning this repostiory but before building the demo you need to obtain git submodules by running `build_demo.sh update_git`

`build_demo.sh` script provides flexible options for building the demo and running it. For example,
- it allows to build Parsec service docker images with either Mbed-Crypto or TPM provider configured
- it supports cases when Parsec service is already configured and running on the host instead of a docker container
- it allows to use either automatic or manual GreenGrass IoT Thing provisioning

If the demo is run with automatic provisioning then the device keys and certificate will be generated by AWS,
downloaded to the device and the keys will be imported into Parsec. Please notice that automatic provisionning
only possible if Parsec is configured with a provider supporting private key import.
If manual provisioning is selected then device keys and a CSR will be generated locally using Parsec and the device
ceritifcate will be created by AWS from the CSR using `aws iot create-certificate-from-csr`.
Any Parsec provider can be used with manual provisionning.

`build_demo.sh` script contains quite a few functions which can be run as the script paremeter and provide required
functionality from building everything and run the demo in one go to building/running bits and pieces of the demo separately.

Examples of the script usage:
- `build_demo.sh` - without paremeters the script will build GreenGrass and Parsec+Mbed-Crypto provider docker images and will start GreenGrass with automatic provisionning
-
- `build_demo.sh build` - build GreenGrass and Parsec+Mbed-Crypto provider docker images
- `build_demo.sh build_tpm` - build GreenGrass and Parsec+TPM provider docker images
- `build_demo.sh build_gg` - build GreenGrass docker images only
- `build_demo.sh build_parsec_image` - build Parsec+Mbed-Crypto provider docker image
- `build_demo.sh build_parsec_tpm_image` - build Parsec+TPM provider docker image
-
- `build_demo.sh run_demo` - start Parsec+Mbed-Crypto provider and GreenGrass docker containers with automatic IoT thing provisionning
- `build_demo.sh run_manual_demo` - start Parsec+Mbed-Crypto provider and GreenGrass docker containers with manual IoT thing provisionning
- `build_demo.sh run_manual_demo_tpm` - start Parsec+TPM provider and GreenGrass docker containers with manual IoT thing provisionning

#### Additional notes

If you already have Parsec service running on the host and would like to use it for GreenGrass then just skip building
Parsec docker images in you build procedure. For example:
```
./build_demo.sh build_gg
./build_demo.sh run_manual_demo

#or build_demo.sh run_demo
```

Please notice that we're using a docker volume for GreenGrass user home. The IoT thing will not be manually provisioned if
it was provisioned before. If you would like to re-provision it then add `init` parameter. For example:
```
./build_demo.sh run_manual_demo init
```

`build_demo.sh` script and GreenGrass use some ENV variables which should be defined in `secrets.env` file in the same directory where the script is.
This is what can be defined:
- Mandatory settings
   - AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY - AWS access settings
   - AWS_REGION - The AWS region where the IOT thing will be created
- Optional settings
   - GG_THING_NAME - AWS IOT thing name. (default: the device host name)
   - GG_THING_GROUP - IOT group name for the thing. (default: ${AWS_ROLE_PREFIX}GreengrassQuickStartGroup)
   - AWS_ROLE_PREFIX - A prefix added to all created AWS policies and roles names. (default: empty)
   - AWS_SESSION_TOKEN - AWS session token if required.
   - AWS_BOUNDARY_POLICY - A boundary policy name for IAM roles if required.

### Example of 

Example of 3 screens, PArsec Service, Greengrass Local Debug Console showing 
<img src="docs/56kcloud_parsec_greengrass_onrb5_sucess.png" alt="56K.Cloud Logo" height="1024">

## Contributions

Companies and Individusl that have contributed and participated in building this workshop
* [56K.Cloud](https://blog.56k.cloud/arm-parsec-and-56k-5gusecases/)
* [SayDo](https://www.saydo.co/en/)
* [ReVault](https://revault.ch/en/#)
* [Solid-Run](https://solid-run.com/)
* [ARM](https://developer.arm.com/solutions/infrastructure/developer-resources/security/parsec)